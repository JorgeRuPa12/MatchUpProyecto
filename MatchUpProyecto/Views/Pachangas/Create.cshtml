<h1>Crear un partido</h1>

<div id="map" style="height: 600px; width: 600px"></div>

<form method="post">
    <input type="hidden" name="id" value="0" />
    <input type="hidden" name="ganador" value="0" />
    <label>Deporte: </label>
    <input type="text" name="deporte" class="form-control" />
    <input type="text" name="ubilatitud" class="form-control" id="lat"/>
    <input type="text" name="ubilongitud" class="form-control" id="lng"/>
    <input type="text" name="ubiprovincia" class="form-control" id="provincia" />
    <label>Inscripcion: </label>
    <input type="text" name="inscripcion" class="form-control" />
    <label>Acceso: </label>
    <input type="text" name="acceso" class="form-control" />
    <button class="btn btn-primary">Crear</button>
</form>

<!-- Agregar la librería Turf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>

<script>
    var map = L.map('map').setView([40.4168, -3.7038], 6); // Coordenadas de Madrid

    // Límite geográfico de España (aproximado)
    var bounds = [
        [35.0, -10.0],  // Suroeste (Islas Canarias)
        [44.5, 5.0]      // Noreste
    ];

    map.setMaxBounds(bounds);
    map.on('drag', function () {
        map.panInsideBounds(bounds, { animate: false });
    });

    // Agregar capa base de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    var provinciasLayer; // Guardar la capa de provincias
    var geojsonData;  // Guardar los datos GeoJSON para futuras consultas

    fetch('/geo/spain-provinces.geojson')
        .then(response => response.json())
        .then(data => {
            geojsonData = data; // Guardamos los datos del GeoJSON

            provinciasLayer = L.geoJSON(data, {
                style: function (feature) {
                    return { color: "rgba(31, 82, 44, 0.5)", weight: 2, fillOpacity: 0.2 };
                },
                onEachFeature: function (feature, layer) {
                    layer.on('click', function (e) {
                        // Obtener el nombre de la comunidad autónoma
                        var nombreComunidad = feature.properties.name;

                        // Mostrarlo en el input
                        document.getElementById("provincia").value = nombreComunidad;

                        // Evitar que el clic se propague al mapa
                        e.originalEvent.stopPropagation();
                    });
                }
            }).addTo(map);
        }).catch(error => console.error('Error al cargar el GeoJSON:', error));

    // Crear marcador arrastrable en Madrid
    var marker = L.marker([40.4168, -3.7038], { draggable: true }).addTo(map);

    function actualizarUbicacion(latlng) {
        document.getElementById("lat").value = latlng.lat;
        document.getElementById("lng").value = latlng.lng;

        // Crear un punto con Turf.js
        var punto = turf.point([latlng.lng, latlng.lat]);

        // Verificar en qué comunidad autónoma se encuentra el punto
        var comunidadEncontrada = null;
        geojsonData.features.forEach(function (feature) {
            var poligono = turf.polygon(feature.geometry.coordinates);
            if (turf.booleanPointInPolygon(punto, poligono)) {
                comunidadEncontrada = feature.properties.name;
            }
        });

        // Actualizar el input con la comunidad autónoma correcta
        if (comunidadEncontrada) {
            document.getElementById("provincia").value = comunidadEncontrada;
        } else {
            document.getElementById("provincia").value = "";
        }
    }

    // Evento al soltar el marcador
    marker.on('dragend', function (e) {
        actualizarUbicacion(marker.getLatLng());
    });

    // Evento de clic en el mapa para mover el marcador
    map.on('click', function (e) {
        if (bounds[0][0] <= e.latlng.lat && e.latlng.lat <= bounds[1][0] &&
            bounds[0][1] <= e.latlng.lng && e.latlng.lng <= bounds[1][1]) {
            marker.setLatLng(e.latlng);
            actualizarUbicacion(e.latlng);
        }
    });
</script>